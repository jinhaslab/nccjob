<!DOCTYPE html>
<html lang="ko">
  {% load record_extras %}
  {% load static %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸°ë¡ ìˆ˜ì •:{{ record.case.fid }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="{% static 'records/css/record_form.css' %}" />
  </head>
  <body>
    <div class="main-wrapper">
      <div class="pdf-section">
        <div class="resizer" id="resizer"></div>
        <div class="pdf-viewer">
          {% if record.case.fid %}
          <iframe
            src="https://jinhaslab.github.io/nccjob/{{ record.case.fid }}.html"
            title="ì›ë³¸ HTML ë·°ì–´"
            onload="console.log('HTML iframe loaded successfully from GitHub Pages')"
            onerror="console.error('HTML iframe failed to load from GitHub Pages')"
            style="background-color: #f0f0f0; border: 2px solid #28a745;"
          ></iframe>
          <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; border-radius: 3px; z-index: 1000;">
            ì›ë³¸ íŒŒì¼: {{ record.case.fid }}.html
          </div>
          {% else %}
          <p style="text-align: center; padding-top: 40px">í‘œì‹œí•  HTML ì›ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
      </div>

      <div class="form-content">
        <h1>ê¸°ë¡ ìˆ˜ì • {{ record.case.fid }}</h1>
        <form method="post" action="{% url 'record_edit' record.pk %}?{{ other_params }}">
          {% csrf_token %}

          <!-- í•„ìˆ˜ Hidden í•„ë“œë“¤ -->
          <input type="hidden" name="ids" value="{{ record.ids|default:'' }}" />

          <!-- Readonly í•„ë“œë“¤ -->
          {% include 'records/components/readonly_fields.html' %}

          <h2>ìµœì´ˆ & ìµœì¢… ë³€ê²½ ë‚´ì—­
            <button type="button" class="btn btn-secondary mt-2" id="rag-search-button" data-toggle="modal" data-target="#ragSearchModal">
              RAG ê²€ìƒ‰
            </button>
          </h2>

          <!-- ë¹„êµ í…Œì´ë¸” -->
          {% include 'records/components/comparison_table.html' %}

          <!-- í™•ì¸ ì²´í¬ë°•ìŠ¤ -->
          {% include 'records/components/confirmation_section.html' %}

          <div class="action-buttons">
            <button type="submit" class="btn btn-success">ğŸ’¾ ì €ì¥</button>
            <a href="{% url 'record_list' %}?{{ other_params }}" class="btn btn-secondary">ì·¨ì†Œ</a>
          </div>

          </div>
        </form>
      </div>
    </div>

    <!-- RAG ê²€ìƒ‰ ëª¨ë‹¬ -->
    {% include 'records/components/rag_search_modal.html' %}


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- ì„¤ì • ê°ì²´ -->
    <script>
      window.RECORD_FORM_CONFIG = {
        autocompleteUrl: "{% url 'autocomplete_suggestions' %}",
        getDiseaseCodeUrl: "{% url 'get_disease_code_by_name' %}",
        getJobCodeUrl: "{% url 'get_job_code_by_occupation_name' %}",
        ragSearchApiUrl: "{% url 'proxy_rag_search' %}",
        hasDiseaseFk: {{ record.disease|yesno:"true,false" }},
        hasJobFk: {{ record.job|yesno:"true,false" }}
      };
    </script>

    <!-- ë©”ì¸ JavaScript -->
    <script src="{% static 'records/js/form_scripts.js' %}"></script>

    <!-- í˜ì´ì§€ ë¦¬ì‚¬ì´ì € ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // ğŸ¡ **SCROLL WHEEL RESIZER SYSTEM (600px start)**
        const resizer = document.getElementById('resizer');
        const mainWrapper = document.querySelector('.main-wrapper');
        const pdfSection = document.querySelector('.pdf-section');

        if (resizer && mainWrapper && pdfSection) {
          let currentPdfWidth = 600; // ì´ˆê¸°ê°’
          let isHoveringResizer = false;

          // ğŸ¡ **Get current PDF width from grid**
          function getCurrentPdfWidth() {
            const currentCols = window.getComputedStyle(mainWrapper).gridTemplateColumns;
            const match = currentCols.match(/^(\d+)px/);
            return match ? parseInt(match[1]) : 600;
          }

          // ğŸ¨ **Update PDF section width**
          function updatePdfWidth(newWidth) {
            const containerRect = mainWrapper.getBoundingClientRect();
            const totalWidth = containerRect.width;
            const gap = 12; // grid gap

            const minPdfWidth = 200;
            const minContentWidth = 300;
            const maxPdfWidth = totalWidth - gap - minContentWidth;

            // ğŸ¨ **Smooth clamping**
            const clampedWidth = Math.max(minPdfWidth, Math.min(newWidth, maxPdfWidth));

            // âœ¨ **Update grid template columns**
            mainWrapper.style.gridTemplateColumns = `${clampedWidth}px 1fr`;
            currentPdfWidth = clampedWidth;

            return clampedWidth;
          }

          // ğŸ¡ **Scroll wheel event handler**
          function handleWheelResize(e) {
            if (!isHoveringResizer) return;

            e.preventDefault(); // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€

            // ğŸ¡ **Scroll direction and step size**
            const delta = e.deltaY > 0 ? -20 : 20; // ì•„ë˜ ìŠ¤í¬ë¡¤ = ì¶•ì†Œ, ìœ„ ìŠ¤í¬ë¡¤ = í™•ëŒ€
            const newWidth = getCurrentPdfWidth() + delta;

            updatePdfWidth(newWidth);

            // ğŸ¨ **Visual feedback during scroll**
            resizer.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            resizer.style.transform = 'scale(1.1)';

            // Reset visual feedback after 200ms
            setTimeout(() => {
              resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
              resizer.style.transform = 'scale(1)';
            }, 200);
          }

          // ğŸ–±ï¸ **Hover detection for resizer**
          resizer.addEventListener('mouseenter', function() {
            isHoveringResizer = true;
            resizer.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%)';
            resizer.style.cursor = 'grab';
          });

          resizer.addEventListener('mouseleave', function() {
            isHoveringResizer = false;
            resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
            resizer.style.cursor = 'col-resize';
          });

          // ğŸ¡ **Add scroll event listener**
          resizer.addEventListener('wheel', handleWheelResize, { passive: false });

          // ğŸ¯ **Optional: Keyboard shortcuts**
          document.addEventListener('keydown', function(e) {
            if (!isHoveringResizer) return;

            if (e.key === 'ArrowLeft' || e.key === '-') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() - 50);
            } else if (e.key === 'ArrowRight' || e.key === '+') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() + 50);
            }
          });
        }
      });
    </script>
  </body>
</html>