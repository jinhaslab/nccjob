<!DOCTYPE html>
<html lang="ko">
  {% load record_extras %}
  {% load static %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>기록 수정:{{ record.case.fid }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="{% static 'records/css/record_form.css' %}" />
  </head>
  <body>
    <div class="main-wrapper">
      <div class="pdf-section">
        <div class="resizer" id="resizer"></div>
        <div class="pdf-viewer">
          {% if record.case.fid %}
          <iframe
            src="https://jinhaslab.github.io/nccjob/{{ record.case.fid }}.html"
            title="원본 HTML 뷰어"
            onload="console.log('HTML iframe loaded successfully from GitHub Pages')"
            onerror="console.error('HTML iframe failed to load from GitHub Pages')"
            style="background-color: #f0f0f0; border: 2px solid #28a745;"
          ></iframe>
          <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; border-radius: 3px; z-index: 1000;">
            원본 파일: {{ record.case.fid }}.html
          </div>
          {% else %}
          <p style="text-align: center; padding-top: 40px">표시할 HTML 원본이 없습니다.</p>
          {% endif %}
        </div>
      </div>

      <div class="form-content">
        <h1>기록 수정 {{ record.case.fid }}</h1>
        <form method="post" action="{% url 'record_edit' record.pk %}?{{ other_params }}">
          {% csrf_token %}

          <!-- 필수 Hidden 필드들 -->
          <input type="hidden" name="ids" value="{{ record.ids|default:'' }}" />

          <!-- Django Form 필드 직접 렌더링 (테스트용) -->
          <div style="background: #ffffcc; padding: 15px; margin: 10px 0; border: 2px solid #orange;">
            <h3>🔧 직접 Form 필드 (테스트용)</h3>

            <!-- smry 필드 -->
            <label for="id_smry">고찰:</label><br>
            <textarea name="smry" id="id_smry" rows="3" style="width: 100%;">{{ record.smry|default:'' }}</textarea><br><br>

            <!-- decision 필드 -->
            <label for="id_decision">결정사항:</label><br>
            <input type="text" name="decision" id="id_decision" value="{{ record.decision|default:'' }}" style="width: 100%;"><br><br>

            <!-- disease hidden 필드 -->
            <input type="hidden" name="disease" value="{{ record.disease|default:'' }}">

            <!-- job hidden 필드 -->
            <input type="hidden" name="job" value="{{ record.job|default:'' }}">

            <!-- URL 필드들 제거 (Django 폼에서 자동 처리) -->

            <!-- 확인 체크박스들 -->
            <input type="checkbox" name="disease_confirmed" {% if record.disease_confirmed %}checked{% endif %}> 질병 확인<br>
            <input type="checkbox" name="job_confirmed" {% if record.job_confirmed %}checked{% endif %}> 직종 확인<br>
            <input type="checkbox" name="exposure_confirmed" {% if record.exposure_confirmed %}checked{% endif %}> 유해인자 확인<br>
            <input type="checkbox" name="decision_confirmed" {% if record.decision_confirmed %}checked{% endif %}> 결정 확인<br>
            <input type="checkbox" name="smry_confirmed" {% if record.smry_confirmed %}checked{% endif %}> 고찰 확인<br>
          </div>

          <!-- 기존 템플릿들 (숨김 처리) -->
          <div style="display: none;">
            <!-- Readonly 필드들 -->
            {% include 'records/components/readonly_fields.html' %}

            <h2>최초 & 최종 변경 내역
              <button type="button" class="btn btn-secondary mt-2" id="rag-search-button" data-toggle="modal" data-target="#ragSearchModal">
                RAG 검색
              </button>
            </h2>

            <!-- 비교 테이블 -->
            {% include 'records/components/comparison_table.html' %}

            <!-- 확인 체크박스 -->
            {% include 'records/components/confirmation_section.html' %}
          </div>

          <div class="action-buttons">
            <button type="submit" onclick="console.log('저장 버튼 클릭됨'); alert('저장 버튼이 클릭되었습니다!'); return true;" style="background: red; color: white; padding: 15px; border: none; font-size: 16px;">💾 저장</button>

            <!-- 테스트 버튼 -->
            <button type="button" onclick="document.querySelector('form').submit(); alert('강제 제출!');" style="background: blue; color: white; padding: 15px; border: none; font-size: 16px; margin-left: 10px;">🚀 강제 저장</button>

            <a href="{% url 'record_list' %}?{{ other_params }}" class="cancel-link">취소</a>

            <!-- 디버그 정보 -->
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; font-size: 12px;">
              <strong>Debug:</strong><br>
              Form Action: {% url 'record_edit' record.pk %}?{{ other_params }}<br>
              Record ID: {{ record.pk }}<br>
              Method: POST<br>
              CSRF Token: {% csrf_token %}
            </div>

            <!-- Form 정보 디버그 -->
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('form[method="post"]');
                console.log('🔍 Form element found:', !!form);
                console.log('🔍 Form action:', form ? form.action : 'NO FORM');
                console.log('🔍 Form method:', form ? form.method : 'NO FORM');

                // Form submit 이벤트 리스너 추가
                if (form) {
                  form.addEventListener('submit', function(e) {
                    console.log('🔥 Form submit event triggered!');
                    const formData = new FormData(form);
                    console.log('🔥 Form data entries:');
                    for (let [key, value] of formData.entries()) {
                      console.log(`  ${key}: ${value}`);
                    }

                    // 폼 필드들 직접 체크
                    const allInputs = form.querySelectorAll('input, textarea, select');
                    console.log('🔍 All form fields found:', allInputs.length);
                    allInputs.forEach(input => {
                      console.log(`  Field: ${input.name} = ${input.value} (type: ${input.type})`);
                    });

                    alert('Form이 제출됩니다!');
                    // e.preventDefault(); // 주석 처리해서 실제 제출되도록
                  });
                }
              });
            </script>
          </div>
        </form>
      </div>
    </div>

    <!-- RAG 검색 모달 -->
    {% include 'records/components/rag_search_modal.html' %}


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- 설정 객체 -->
    <script>
      window.RECORD_FORM_CONFIG = {
        autocompleteUrl: "{% url 'autocomplete_suggestions' %}",
        getDiseaseCodeUrl: "{% url 'get_disease_code_by_name' %}",
        getJobCodeUrl: "{% url 'get_job_code_by_occupation_name' %}",
        ragSearchApiUrl: "{% url 'proxy_rag_search' %}",
        hasDiseaseFk: {{ record.disease|yesno:"true,false" }},
        hasJobFk: {{ record.job|yesno:"true,false" }}
      };
    </script>

    <!-- 메인 JavaScript -->
    <script src="{% static 'records/js/form_scripts.js' %}"></script>

    <!-- 디버깅용 인라인 스크립트 -->
    <script>
      console.log('=== DEBUGGING START ===');
      console.log('Disease input:', document.getElementById('disease_input'));
      console.log('Disease suggestions:', document.getElementById('disease_suggestions'));
      console.log('Disease hidden:', document.getElementById('disease_hidden'));
      console.log('RECORD_FORM_CONFIG:', window.RECORD_FORM_CONFIG);

      // 간단한 테스트
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, testing disease input...');
        const diseaseInput = document.getElementById('disease_input');
        const diseaseSuggestions = document.getElementById('disease_suggestions');

        if (diseaseInput) {
          console.log('Disease input found, adding test listeners');

          // 클릭 테스트
          diseaseInput.addEventListener('click', function() {
            console.log('Disease input clicked!');
          });

          // 간단한 autocomplete 테스트
          diseaseInput.addEventListener('input', async function(e) {
            console.log('Input event:', e.target.value);

            if (e.target.value.length > 0) {
              try {
                const config = window.RECORD_FORM_CONFIG || {};
                const url = config.autocompleteUrl || '/api/autocomplete/';
                const fullUrl = `${url}?field_name=disease_name&q=${encodeURIComponent(e.target.value)}`;
                console.log('Fetching:', fullUrl);

                const response = await fetch(fullUrl);
                const data = await response.json();
                console.log('Response:', data);

                if (diseaseSuggestions && data.suggestions) {
                  diseaseSuggestions.innerHTML = '';
                  data.suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = suggestion.name || suggestion;
                    div.style.padding = '10px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.addEventListener('click', () => {
                      diseaseInput.value = suggestion.name || suggestion;
                      diseaseSuggestions.style.display = 'none';
                    });
                    diseaseSuggestions.appendChild(div);
                  });
                  diseaseSuggestions.style.display = 'block';
                  diseaseSuggestions.style.position = 'absolute';
                  diseaseSuggestions.style.background = 'white';
                  diseaseSuggestions.style.border = '1px solid #ddd';
                  diseaseSuggestions.style.zIndex = '9999';
                  diseaseSuggestions.style.maxHeight = '200px';
                  diseaseSuggestions.style.overflow = 'auto';
                }
              } catch (error) {
                console.error('Fetch error:', error);
              }
            } else {
              if (diseaseSuggestions) {
                diseaseSuggestions.style.display = 'none';
              }
            }
          });
        } else {
          console.error('Disease input NOT found!');
        }

        // 🎡 **SCROLL WHEEL RESIZER SYSTEM (600px start) - TOP POSITION**
        const resizer = document.getElementById('resizer');
        const mainWrapper = document.querySelector('.main-wrapper');
        const pdfSection = document.querySelector('.pdf-section');

        console.log('🎡 Initializing TOP RESIZER system...');

        if (resizer && mainWrapper && pdfSection) {
          let currentPdfWidth = 600; // 초기값
          let isHoveringResizer = false;

          // 🎡 **Get current PDF width from grid**
          function getCurrentPdfWidth() {
            const currentCols = window.getComputedStyle(mainWrapper).gridTemplateColumns;
            const match = currentCols.match(/^(\d+)px/);
            return match ? parseInt(match[1]) : 600;
          }

          // 🎨 **Update PDF section width**
          function updatePdfWidth(newWidth) {
            const containerRect = mainWrapper.getBoundingClientRect();
            const totalWidth = containerRect.width;
            const gap = 12; // grid gap

            const minPdfWidth = 200;
            const minContentWidth = 300;
            const maxPdfWidth = totalWidth - gap - minContentWidth;

            // 🎨 **Smooth clamping**
            const clampedWidth = Math.max(minPdfWidth, Math.min(newWidth, maxPdfWidth));

            // ✨ **Update grid template columns**
            mainWrapper.style.gridTemplateColumns = `${clampedWidth}px 1fr`;
            currentPdfWidth = clampedWidth;

            console.log(`🎡 TOP Resize: ${clampedWidth}px`);
            return clampedWidth;
          }

          // 🎡 **Scroll wheel event handler**
          function handleWheelResize(e) {
            if (!isHoveringResizer) return;

            e.preventDefault(); // 페이지 스크롤 방지

            // 🎡 **Scroll direction and step size**
            const delta = e.deltaY > 0 ? -20 : 20; // 아래 스크롤 = 축소, 위 스크롤 = 확대
            const newWidth = getCurrentPdfWidth() + delta;

            updatePdfWidth(newWidth);

            // 🎨 **Visual feedback during scroll**
            resizer.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            resizer.style.transform = 'scale(1.1)';

            // Reset visual feedback after 200ms
            setTimeout(() => {
              resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
              resizer.style.transform = 'scale(1)';
            }, 200);
          }

          // 🖱️ **Hover detection for resizer**
          resizer.addEventListener('mouseenter', function() {
            isHoveringResizer = true;
            resizer.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%)';
            resizer.style.cursor = 'grab';
            console.log('🎡 Hovering resizer - scroll to resize!');
          });

          resizer.addEventListener('mouseleave', function() {
            isHoveringResizer = false;
            resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
            resizer.style.cursor = 'col-resize';
            console.log('🎡 Left resizer');
          });

          // 🎡 **Add scroll event listener**
          resizer.addEventListener('wheel', handleWheelResize, { passive: false });

          // 🎯 **Optional: Keyboard shortcuts**
          document.addEventListener('keydown', function(e) {
            if (!isHoveringResizer) return;

            if (e.key === 'ArrowLeft' || e.key === '-') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() - 50);
            } else if (e.key === 'ArrowRight' || e.key === '+') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() + 50);
            }
          });

          console.log('✅ SCROLL WHEEL Resizer initialized! Starting at 600px');
          console.log('💡 Hover over resizer and use mouse wheel to resize!');
        } else {
          console.error('❌ Failed to initialize resizer');
        }
      });
    </script>
  </body>
</html>