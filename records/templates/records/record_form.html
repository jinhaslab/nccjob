<!DOCTYPE html>
<html lang="ko">
  {% load record_extras %}
  {% load static %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê¸°ë¡ ìˆ˜ì •:{{ record.case.fid }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="{% static 'records/css/record_form.css' %}" />
  </head>
  <body>
    <div class="main-wrapper">
      <div class="pdf-section">
        <div class="resizer" id="resizer"></div>
        <div class="pdf-viewer">
          {% if record.case.fid %}
          <iframe
            src="https://jinhaslab.github.io/nccjob/{{ record.case.fid }}.html"
            title="ì›ë³¸ HTML ë·°ì–´"
            onload="console.log('HTML iframe loaded successfully from GitHub Pages')"
            onerror="console.error('HTML iframe failed to load from GitHub Pages')"
            style="background-color: #f0f0f0; border: 2px solid #28a745;"
          ></iframe>
          <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; border-radius: 3px; z-index: 1000;">
            ì›ë³¸ íŒŒì¼: {{ record.case.fid }}.html
          </div>
          {% else %}
          <p style="text-align: center; padding-top: 40px">í‘œì‹œí•  HTML ì›ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endif %}
        </div>
      </div>

      <div class="form-content">
        <h1>ê¸°ë¡ ìˆ˜ì • {{ record.case.fid }}</h1>
        <form method="post" action="{% url 'record_edit' record.pk %}?{{ other_params }}">
          {% csrf_token %}

          <!-- í•„ìˆ˜ Hidden í•„ë“œë“¤ -->
          <input type="hidden" name="ids" value="{{ record.ids|default:'' }}" />

          <!-- Django Form í•„ë“œ ì§ì ‘ ë Œë”ë§ (í…ŒìŠ¤íŠ¸ìš©) -->
          <div style="background: #ffffcc; padding: 15px; margin: 10px 0; border: 2px solid #orange;">
            <h3>ğŸ”§ ì§ì ‘ Form í•„ë“œ (í…ŒìŠ¤íŠ¸ìš©)</h3>

            <!-- smry í•„ë“œ -->
            <label for="id_smry">ê³ ì°°:</label><br>
            <textarea name="smry" id="id_smry" rows="3" style="width: 100%;">{{ record.smry|default:'' }}</textarea><br><br>

            <!-- decision í•„ë“œ -->
            <label for="id_decision">ê²°ì •ì‚¬í•­:</label><br>
            <input type="text" name="decision" id="id_decision" value="{{ record.decision|default:'' }}" style="width: 100%;"><br><br>

            <!-- disease hidden í•„ë“œ -->
            <input type="hidden" name="disease" value="{{ record.disease|default:'' }}">

            <!-- job hidden í•„ë“œ -->
            <input type="hidden" name="job" value="{{ record.job|default:'' }}">

            <!-- URL í•„ë“œë“¤ ì œê±° (Django í¼ì—ì„œ ìë™ ì²˜ë¦¬) -->

            <!-- í™•ì¸ ì²´í¬ë°•ìŠ¤ë“¤ -->
            <input type="checkbox" name="disease_confirmed" {% if record.disease_confirmed %}checked{% endif %}> ì§ˆë³‘ í™•ì¸<br>
            <input type="checkbox" name="job_confirmed" {% if record.job_confirmed %}checked{% endif %}> ì§ì¢… í™•ì¸<br>
            <input type="checkbox" name="exposure_confirmed" {% if record.exposure_confirmed %}checked{% endif %}> ìœ í•´ì¸ì í™•ì¸<br>
            <input type="checkbox" name="decision_confirmed" {% if record.decision_confirmed %}checked{% endif %}> ê²°ì • í™•ì¸<br>
            <input type="checkbox" name="smry_confirmed" {% if record.smry_confirmed %}checked{% endif %}> ê³ ì°° í™•ì¸<br>
          </div>

          <!-- ê¸°ì¡´ í…œí”Œë¦¿ë“¤ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
          <div style="display: none;">
            <!-- Readonly í•„ë“œë“¤ -->
            {% include 'records/components/readonly_fields.html' %}

            <h2>ìµœì´ˆ & ìµœì¢… ë³€ê²½ ë‚´ì—­
              <button type="button" class="btn btn-secondary mt-2" id="rag-search-button" data-toggle="modal" data-target="#ragSearchModal">
                RAG ê²€ìƒ‰
              </button>
            </h2>

            <!-- ë¹„êµ í…Œì´ë¸” -->
            {% include 'records/components/comparison_table.html' %}

            <!-- í™•ì¸ ì²´í¬ë°•ìŠ¤ -->
            {% include 'records/components/confirmation_section.html' %}
          </div>

          <div class="action-buttons">
            <button type="submit" onclick="console.log('ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨'); alert('ì €ì¥ ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤!'); return true;" style="background: red; color: white; padding: 15px; border: none; font-size: 16px;">ğŸ’¾ ì €ì¥</button>

            <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
            <button type="button" onclick="document.querySelector('form').submit(); alert('ê°•ì œ ì œì¶œ!');" style="background: blue; color: white; padding: 15px; border: none; font-size: 16px; margin-left: 10px;">ğŸš€ ê°•ì œ ì €ì¥</button>

            <a href="{% url 'record_list' %}?{{ other_params }}" class="cancel-link">ì·¨ì†Œ</a>

            <!-- ë””ë²„ê·¸ ì •ë³´ -->
            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; font-size: 12px;">
              <strong>Debug:</strong><br>
              Form Action: {% url 'record_edit' record.pk %}?{{ other_params }}<br>
              Record ID: {{ record.pk }}<br>
              Method: POST<br>
              CSRF Token: {% csrf_token %}
            </div>

            <!-- Form ì •ë³´ ë””ë²„ê·¸ -->
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('form[method="post"]');
                console.log('ğŸ” Form element found:', !!form);
                console.log('ğŸ” Form action:', form ? form.action : 'NO FORM');
                console.log('ğŸ” Form method:', form ? form.method : 'NO FORM');

                // Form submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (form) {
                  form.addEventListener('submit', function(e) {
                    console.log('ğŸ”¥ Form submit event triggered!');
                    const formData = new FormData(form);
                    console.log('ğŸ”¥ Form data entries:');
                    for (let [key, value] of formData.entries()) {
                      console.log(`  ${key}: ${value}`);
                    }

                    // í¼ í•„ë“œë“¤ ì§ì ‘ ì²´í¬
                    const allInputs = form.querySelectorAll('input, textarea, select');
                    console.log('ğŸ” All form fields found:', allInputs.length);
                    allInputs.forEach(input => {
                      console.log(`  Field: ${input.name} = ${input.value} (type: ${input.type})`);
                    });

                    alert('Formì´ ì œì¶œë©ë‹ˆë‹¤!');
                    // e.preventDefault(); // ì£¼ì„ ì²˜ë¦¬í•´ì„œ ì‹¤ì œ ì œì¶œë˜ë„ë¡
                  });
                }
              });
            </script>
          </div>
        </form>
      </div>
    </div>

    <!-- RAG ê²€ìƒ‰ ëª¨ë‹¬ -->
    {% include 'records/components/rag_search_modal.html' %}


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- ì„¤ì • ê°ì²´ -->
    <script>
      window.RECORD_FORM_CONFIG = {
        autocompleteUrl: "{% url 'autocomplete_suggestions' %}",
        getDiseaseCodeUrl: "{% url 'get_disease_code_by_name' %}",
        getJobCodeUrl: "{% url 'get_job_code_by_occupation_name' %}",
        ragSearchApiUrl: "{% url 'proxy_rag_search' %}",
        hasDiseaseFk: {{ record.disease|yesno:"true,false" }},
        hasJobFk: {{ record.job|yesno:"true,false" }}
      };
    </script>

    <!-- ë©”ì¸ JavaScript -->
    <script src="{% static 'records/js/form_scripts.js' %}"></script>

    <!-- ë””ë²„ê¹…ìš© ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      console.log('=== DEBUGGING START ===');
      console.log('Disease input:', document.getElementById('disease_input'));
      console.log('Disease suggestions:', document.getElementById('disease_suggestions'));
      console.log('Disease hidden:', document.getElementById('disease_hidden'));
      console.log('RECORD_FORM_CONFIG:', window.RECORD_FORM_CONFIG);

      // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, testing disease input...');
        const diseaseInput = document.getElementById('disease_input');
        const diseaseSuggestions = document.getElementById('disease_suggestions');

        if (diseaseInput) {
          console.log('Disease input found, adding test listeners');

          // í´ë¦­ í…ŒìŠ¤íŠ¸
          diseaseInput.addEventListener('click', function() {
            console.log('Disease input clicked!');
          });

          // ê°„ë‹¨í•œ autocomplete í…ŒìŠ¤íŠ¸
          diseaseInput.addEventListener('input', async function(e) {
            console.log('Input event:', e.target.value);

            if (e.target.value.length > 0) {
              try {
                const config = window.RECORD_FORM_CONFIG || {};
                const url = config.autocompleteUrl || '/api/autocomplete/';
                const fullUrl = `${url}?field_name=disease_name&q=${encodeURIComponent(e.target.value)}`;
                console.log('Fetching:', fullUrl);

                const response = await fetch(fullUrl);
                const data = await response.json();
                console.log('Response:', data);

                if (diseaseSuggestions && data.suggestions) {
                  diseaseSuggestions.innerHTML = '';
                  data.suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = suggestion.name || suggestion;
                    div.style.padding = '10px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.addEventListener('click', () => {
                      diseaseInput.value = suggestion.name || suggestion;
                      diseaseSuggestions.style.display = 'none';
                    });
                    diseaseSuggestions.appendChild(div);
                  });
                  diseaseSuggestions.style.display = 'block';
                  diseaseSuggestions.style.position = 'absolute';
                  diseaseSuggestions.style.background = 'white';
                  diseaseSuggestions.style.border = '1px solid #ddd';
                  diseaseSuggestions.style.zIndex = '9999';
                  diseaseSuggestions.style.maxHeight = '200px';
                  diseaseSuggestions.style.overflow = 'auto';
                }
              } catch (error) {
                console.error('Fetch error:', error);
              }
            } else {
              if (diseaseSuggestions) {
                diseaseSuggestions.style.display = 'none';
              }
            }
          });
        } else {
          console.error('Disease input NOT found!');
        }

        // ğŸ¡ **SCROLL WHEEL RESIZER SYSTEM (600px start) - TOP POSITION**
        const resizer = document.getElementById('resizer');
        const mainWrapper = document.querySelector('.main-wrapper');
        const pdfSection = document.querySelector('.pdf-section');

        console.log('ğŸ¡ Initializing TOP RESIZER system...');

        if (resizer && mainWrapper && pdfSection) {
          let currentPdfWidth = 600; // ì´ˆê¸°ê°’
          let isHoveringResizer = false;

          // ğŸ¡ **Get current PDF width from grid**
          function getCurrentPdfWidth() {
            const currentCols = window.getComputedStyle(mainWrapper).gridTemplateColumns;
            const match = currentCols.match(/^(\d+)px/);
            return match ? parseInt(match[1]) : 600;
          }

          // ğŸ¨ **Update PDF section width**
          function updatePdfWidth(newWidth) {
            const containerRect = mainWrapper.getBoundingClientRect();
            const totalWidth = containerRect.width;
            const gap = 12; // grid gap

            const minPdfWidth = 200;
            const minContentWidth = 300;
            const maxPdfWidth = totalWidth - gap - minContentWidth;

            // ğŸ¨ **Smooth clamping**
            const clampedWidth = Math.max(minPdfWidth, Math.min(newWidth, maxPdfWidth));

            // âœ¨ **Update grid template columns**
            mainWrapper.style.gridTemplateColumns = `${clampedWidth}px 1fr`;
            currentPdfWidth = clampedWidth;

            console.log(`ğŸ¡ TOP Resize: ${clampedWidth}px`);
            return clampedWidth;
          }

          // ğŸ¡ **Scroll wheel event handler**
          function handleWheelResize(e) {
            if (!isHoveringResizer) return;

            e.preventDefault(); // í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€

            // ğŸ¡ **Scroll direction and step size**
            const delta = e.deltaY > 0 ? -20 : 20; // ì•„ë˜ ìŠ¤í¬ë¡¤ = ì¶•ì†Œ, ìœ„ ìŠ¤í¬ë¡¤ = í™•ëŒ€
            const newWidth = getCurrentPdfWidth() + delta;

            updatePdfWidth(newWidth);

            // ğŸ¨ **Visual feedback during scroll**
            resizer.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            resizer.style.transform = 'scale(1.1)';

            // Reset visual feedback after 200ms
            setTimeout(() => {
              resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
              resizer.style.transform = 'scale(1)';
            }, 200);
          }

          // ğŸ–±ï¸ **Hover detection for resizer**
          resizer.addEventListener('mouseenter', function() {
            isHoveringResizer = true;
            resizer.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%)';
            resizer.style.cursor = 'grab';
            console.log('ğŸ¡ Hovering resizer - scroll to resize!');
          });

          resizer.addEventListener('mouseleave', function() {
            isHoveringResizer = false;
            resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
            resizer.style.cursor = 'col-resize';
            console.log('ğŸ¡ Left resizer');
          });

          // ğŸ¡ **Add scroll event listener**
          resizer.addEventListener('wheel', handleWheelResize, { passive: false });

          // ğŸ¯ **Optional: Keyboard shortcuts**
          document.addEventListener('keydown', function(e) {
            if (!isHoveringResizer) return;

            if (e.key === 'ArrowLeft' || e.key === '-') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() - 50);
            } else if (e.key === 'ArrowRight' || e.key === '+') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() + 50);
            }
          });

          console.log('âœ… SCROLL WHEEL Resizer initialized! Starting at 600px');
          console.log('ğŸ’¡ Hover over resizer and use mouse wheel to resize!');
        } else {
          console.error('âŒ Failed to initialize resizer');
        }
      });
    </script>
  </body>
</html>