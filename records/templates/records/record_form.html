<!DOCTYPE html>
<html lang="ko">
  {% load record_extras %}
  {% load static %}

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>기록 수정:{{ record.case.fid }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="{% static 'records/css/record_form.css' %}" />
  </head>
  <body>
    <div class="main-wrapper">
      <div class="pdf-section">
        <div class="resizer" id="resizer"></div>
        <div class="pdf-viewer">
          {% if record.case.fid %}
          <iframe
            src="https://jinhaslab.github.io/nccjob/{{ record.case.fid }}.html"
            title="원본 HTML 뷰어"
            onload="console.log('HTML iframe loaded successfully from GitHub Pages')"
            onerror="console.error('HTML iframe failed to load from GitHub Pages')"
            style="background-color: #f0f0f0; border: 2px solid #28a745;"
          ></iframe>
          <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 12px; border-radius: 3px; z-index: 1000;">
            원본 파일: {{ record.case.fid }}.html
          </div>
          {% else %}
          <p style="text-align: center; padding-top: 40px">표시할 HTML 원본이 없습니다.</p>
          {% endif %}
        </div>
      </div>

      <div class="form-content">
        <h1>기록 수정 {{ record.case.fid }}</h1>
        <form method="post" action="{% url 'record_edit' record.pk %}?{{ other_params }}">
          {% csrf_token %}

          <!-- 필수 Hidden 필드들 -->
          <input type="hidden" name="ids" value="{{ record.ids|default:'' }}" />

          <!-- Readonly 필드들 -->
          {% include 'records/components/readonly_fields.html' %}

          <h2>최초 & 최종 변경 내역
            <button type="button" class="btn btn-secondary mt-2" id="rag-search-button" data-toggle="modal" data-target="#ragSearchModal">
              RAG 검색
            </button>
          </h2>

          <!-- 비교 테이블 -->
          {% include 'records/components/comparison_table.html' %}

          <!-- 확인 체크박스 -->
          {% include 'records/components/confirmation_section.html' %}

          <div class="action-buttons">
            <button type="submit" class="btn btn-success">💾 저장</button>
            <a href="{% url 'record_list' %}?{{ other_params }}" class="btn btn-secondary">취소</a>
          </div>

          </div>
        </form>
      </div>
    </div>

    <!-- RAG 검색 모달 -->
    {% include 'records/components/rag_search_modal.html' %}


    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- 설정 객체 -->
    <script>
      window.RECORD_FORM_CONFIG = {
        autocompleteUrl: "{% url 'autocomplete_suggestions' %}",
        getDiseaseCodeUrl: "{% url 'get_disease_code_by_name' %}",
        getJobCodeUrl: "{% url 'get_job_code_by_occupation_name' %}",
        ragSearchApiUrl: "{% url 'proxy_rag_search' %}",
        hasDiseaseFk: {{ record.disease|yesno:"true,false" }},
        hasJobFk: {{ record.job|yesno:"true,false" }}
      };
    </script>

    <!-- 메인 JavaScript -->
    <script src="{% static 'records/js/form_scripts.js' %}"></script>

    <!-- 페이지 리사이저 스크립트 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 🎡 **SCROLL WHEEL RESIZER SYSTEM (600px start)**
        const resizer = document.getElementById('resizer');
        const mainWrapper = document.querySelector('.main-wrapper');
        const pdfSection = document.querySelector('.pdf-section');

        if (resizer && mainWrapper && pdfSection) {
          let currentPdfWidth = 600; // 초기값
          let isHoveringResizer = false;

          // 🎡 **Get current PDF width from grid**
          function getCurrentPdfWidth() {
            const currentCols = window.getComputedStyle(mainWrapper).gridTemplateColumns;
            const match = currentCols.match(/^(\d+)px/);
            return match ? parseInt(match[1]) : 600;
          }

          // 🎨 **Update PDF section width**
          function updatePdfWidth(newWidth) {
            const containerRect = mainWrapper.getBoundingClientRect();
            const totalWidth = containerRect.width;
            const gap = 12; // grid gap

            const minPdfWidth = 200;
            const minContentWidth = 300;
            const maxPdfWidth = totalWidth - gap - minContentWidth;

            // 🎨 **Smooth clamping**
            const clampedWidth = Math.max(minPdfWidth, Math.min(newWidth, maxPdfWidth));

            // ✨ **Update grid template columns**
            mainWrapper.style.gridTemplateColumns = `${clampedWidth}px 1fr`;
            currentPdfWidth = clampedWidth;

            return clampedWidth;
          }

          // 🎡 **Scroll wheel event handler**
          function handleWheelResize(e) {
            if (!isHoveringResizer) return;

            e.preventDefault(); // 페이지 스크롤 방지

            // 🎡 **Scroll direction and step size**
            const delta = e.deltaY > 0 ? -20 : 20; // 아래 스크롤 = 축소, 위 스크롤 = 확대
            const newWidth = getCurrentPdfWidth() + delta;

            updatePdfWidth(newWidth);

            // 🎨 **Visual feedback during scroll**
            resizer.style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
            resizer.style.transform = 'scale(1.1)';

            // Reset visual feedback after 200ms
            setTimeout(() => {
              resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
              resizer.style.transform = 'scale(1)';
            }, 200);
          }

          // 🖱️ **Hover detection for resizer**
          resizer.addEventListener('mouseenter', function() {
            isHoveringResizer = true;
            resizer.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%)';
            resizer.style.cursor = 'grab';
          });

          resizer.addEventListener('mouseleave', function() {
            isHoveringResizer = false;
            resizer.style.background = 'linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 50%, #e2e8f0 100%)';
            resizer.style.cursor = 'col-resize';
          });

          // 🎡 **Add scroll event listener**
          resizer.addEventListener('wheel', handleWheelResize, { passive: false });

          // 🎯 **Optional: Keyboard shortcuts**
          document.addEventListener('keydown', function(e) {
            if (!isHoveringResizer) return;

            if (e.key === 'ArrowLeft' || e.key === '-') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() - 50);
            } else if (e.key === 'ArrowRight' || e.key === '+') {
              e.preventDefault();
              updatePdfWidth(getCurrentPdfWidth() + 50);
            }
          });
        }
      });
    </script>
  </body>
</html>